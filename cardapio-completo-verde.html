<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Card√°pio do Dia - Pastel Food Truck</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/cardapio-verde.css">
  <style>
    .cardapio-verde .header-verde { display: flex; align-items: center; justify-content: space-between; gap: 8px; }
    .cardapio-verde .header-verde .titulo-centro { flex: 1; text-align: center; font-size: 1rem; margin: 0; display: flex; align-items: center; justify-content: center; gap: 6px; }
    .cardapio-verde .header-verde .titulo-centro .titulo-icone { font-size: 1.1rem; }
    .cardapio-verde .header-verde .btn-voltar, .cardapio-verde .header-verde .btn-idioma { flex-shrink: 0; background: rgba(255,255,255,0.25); border: 2px solid rgba(255,255,255,0.5); color: white; padding: 8px 14px; border-radius: 12px; font-size: 13px; font-weight: 700; cursor: pointer; text-decoration: none; }
    .cardapio-verde .header-verde .btn-carrinho { flex-shrink: 0; background: rgba(255,255,255,0.25); border: 2px solid rgba(255,255,255,0.5); color: white; padding: 8px 14px; border-radius: 12px; font-size: 13px; font-weight: 700; text-decoration: none; display: inline-flex; align-items: center; gap: 6px; }
    .cardapio-verde .section-title { text-align: center; color: #1a3d0a; font-size: 0.95rem; margin: 0 0 1rem; font-weight: 600; }
  </style>
</head>
<body class="cardapio-verde">
  <div id="app">
    <div id="loading">Carregando...</div>
    <div id="error" class="error" hidden></div>

    <div id="main" hidden>
      <header class="header-verde">
        <a href="index.html" class="btn-voltar" id="btnVoltar">‚Üê In√≠cio</a>
        <h1 class="titulo-centro" id="titulo"><span class="titulo-icone" id="tituloIcone">üî•</span> <span id="tituloTexto">Card√°pio do Dia</span></h1>
        <button type="button" class="btn-idioma" id="btnIdioma">JP Êó•Êú¨Ë™û</button>
      </header>

      <p class="section-title" id="subtitulo">Comida tradicional brasileira ¬´Pastel¬ª</p>
      <div id="categorias-container"></div>
    </div>
  </div>

  <!-- Carrinho Flutuante -->
  <div id="carrinho-flutuante" class="carrinho-flutuante hidden">
    <div class="carrinho-info">
      <span class="carrinho-icone">üõí</span>
      <span class="carrinho-badge" id="floating-qty">0</span>
      <span class="carrinho-total" id="floating-total">R$ 0,00</span>
    </div>
    <a href="cardapio-carrinho.html" class="btn-ver-carrinho" id="btn-ver-carrinho">
      Ver carrinho ‚Üí
    </a>
  </div>

  <script src="js/config.js"></script>
  <script src="js/cardapio-dados.js"></script>
  <script>
(function () {
  const CONFIG = window.FOOD_TRUCK_CONFIG;
  let supabase;
  let eventoAtivo = null;
  const CART_KEY = "foodtruck_cart";
  const EVENTO_KEY = "foodtruck_evento_id";

  const $loading = document.getElementById("loading");
  const $error = document.getElementById("error");
  const $main = document.getElementById("main");
  const $categoriasContainer = document.getElementById("categorias-container");
  const $btnIdioma = document.getElementById("btnIdioma");
  const $subtitulo = document.getElementById("subtitulo");
  const $btnVoltar = document.getElementById("btnVoltar");
  const $carrinhoFlutuante = document.getElementById("carrinho-flutuante");
  const $floatingQty = document.getElementById("floating-qty");
  const $floatingTotal = document.getElementById("floating-total");
  const $btnVerCarrinho = document.getElementById("btn-ver-carrinho");

  let idioma = localStorage.getItem("idioma") || "pt";
  let ultimosItens = [];
  let categorias = [];

  function getCart() {
    try {
      const raw = localStorage.getItem(CART_KEY);
      return raw ? JSON.parse(raw) : [];
    } catch (_) { return []; }
  }

  function saveCart(cart) {
    localStorage.setItem(CART_KEY, JSON.stringify(cart));
  }

  function updateFloatingCart() {
    const cart = getCart();
    const qty = cart.reduce((s, i) => s + (i.quantidade || 0), 0);
    const total = cart.reduce((s, i) => s + (i.preco || 0) * (i.quantidade || 0), 0);

    $floatingQty.textContent = qty;
    $floatingTotal.textContent = formatPrice(total);

    if (qty > 0) {
      $carrinhoFlutuante.classList.remove("hidden");
    } else {
      $carrinhoFlutuante.classList.add("hidden");
    }

    // Atualizar texto do bot√£o
    const t = textos();
    $btnVerCarrinho.textContent = t.verCarrinho + " ‚Üí";
  }

  function addToCart(item) {
    const cart = getCart();
    const existing = cart.find(c => c.id === item.id);
    if (existing) {
      existing.quantidade += 1;
    } else {
      cart.push({
        id: item.id,
        nome: item.nome,
        preco: item.preco,
        quantidade: 1
      });
    }
    saveCart(cart);
    updateFloatingCart();
    updateFloatingCart();
  }

  function hideLoading() { $loading.hidden = true; }
  function showError(msg) { $error.textContent = msg; $error.hidden = false; }

  function initSupabase() {
    supabase = window.supabase.createClient(CONFIG.supabaseUrl, CONFIG.supabaseAnonKey);
  }

  function textos() {
    return idioma === "ja"
      ? { titulo: "Êú¨Êó•„ÅÆ„É°„Éã„É•„Éº", subtitulo: "„Éñ„É©„Ç∏„É´„ÅÆ‰ºùÁµ±ÊñôÁêÜ„Äå„Éë„Çπ„ÉÜ„É´„Äç", voltar: "‚Üê „Éõ„Éº„É†", idioma: "üáßüá∑ PT", verCarrinho: "„Ç´„Éº„Éà„ÇíË¶ã„Çã", popular: "‰∫∫Ê∞ó" }
      : { titulo: "Card√°pio do Dia", subtitulo: "Comida tradicional brasileira ¬´Pastel¬ª", voltar: "‚Üê In√≠cio", idioma: "JP Êó•Êú¨Ë™û", verCarrinho: "Ver carrinho", popular: "Popular" };
  }

  function formatPrice(preco) {
    return "¬•" + Math.round(Number(preco)).toLocaleString();
  }

  function atualizarUI() {
    const t = textos();
    var tituloEl = document.getElementById("tituloTexto");
    if (tituloEl) tituloEl.textContent = t.titulo;
    $subtitulo.textContent = t.subtitulo;
    $btnVoltar.textContent = t.voltar;
    $btnIdioma.textContent = t.idioma;
    $btnVerCarrinho.textContent = t.verCarrinho + " ‚Üí";
  }

  $btnIdioma.addEventListener("click", function () {
    idioma = idioma === "ja" ? "pt" : "ja";
    localStorage.setItem("idioma", idioma);
    atualizarUI();
    if (ultimosItens.length) renderCategoriasECards(categorias, ultimosItens);
    updateFloatingCart();
  });

  function renderCategoriasECards(cats, itens) {
    const t = textos();
    const infoBySlug = window.PASTEIS_INFO || {};

    // Se n√£o h√° itens, n√£o renderiza nada
    if (!itens || itens.length === 0) {
      $categoriasContainer.innerHTML = '<p style="text-align:center;color:#666;padding:2rem;">Nenhum item dispon√≠vel</p>';
      return;
    }

    // Se n√£o h√° categorias, mostrar todos os itens em uma √∫nica se√ß√£o
    if (!cats || cats.length === 0) {
      let html = '<div class="categoria-secao">';
      html += '<div class="lista-cards">';
      itens.forEach(function(item) {
        html += renderCard(item, infoBySlug, t);
      });
      html += '</div></div>';
      $categoriasContainer.innerHTML = html;
            return;
    }

    // Agrupar itens por categoria
    const itensPorCategoria = {};
    const itensSemCategoria = [];

    itens.forEach(function(item) {
      if (item.categoria_id) {
        if (!itensPorCategoria[item.categoria_id]) {
          itensPorCategoria[item.categoria_id] = [];
        }
        itensPorCategoria[item.categoria_id].push(item);
      } else {
        itensSemCategoria.push(item);
      }
    });

    let html = "";

    // Renderizar cada categoria
    cats.forEach(function(cat) {
      const catItens = itensPorCategoria[cat.id] || [];
      if (catItens.length === 0) return;

      const catNome = idioma === "ja" ? cat.nome_ja : cat.nome_pt;

      html += '<div class="categoria-secao">';
      html += '<div class="categoria-header">';
      html += '<span class="categoria-emoji">' + (cat.emoji || "üì¶") + '</span>';
      html += '<h2 class="categoria-nome">' + escapeHtml(catNome) + '</h2>';
      html += '</div>';
      html += '<div class="lista-cards">';

      catItens.forEach(function(item) {
        html += renderCard(item, infoBySlug, t);
      });

      html += '</div></div>';
    });

    // Renderizar itens sem categoria (fallback)
    if (itensSemCategoria.length > 0) {
      html += '<div class="categoria-secao">';
      html += '<div class="categoria-header">';
      html += '<span class="categoria-emoji">ü•ü</span>';
      html += '<h2 class="categoria-nome">' + (idioma === "ja" ? "„Åù„ÅÆ‰ªñ" : "Outros") + '</h2>';
      html += '</div>';
      html += '<div class="lista-cards">';

      itensSemCategoria.forEach(function(item) {
        html += renderCard(item, infoBySlug, t);
      });

      html += '</div></div>';
    }

    $categoriasContainer.innerHTML = html;
      }


  function renderCard(item, infoBySlug, t) {
    const slug = window.slugFromNome ? window.slugFromNome(item.nome) : "carne";
    const info = infoBySlug[slug] || infoBySlug.carne || {};
    const img = window.imgParaItem ? window.imgParaItem(item.nome) : "img/pastel-carne.png";
    const nomeExibir = idioma === "ja" && info.nome_ja ? info.nome_ja : escapeHtml(item.nome);
    const precoStr = formatPrice(item.preco);
    const isPopular = item.popular === true;

    let cardHtml = '<a href="cardapio-item.html?id=' + encodeURIComponent(item.id) + '" class="opcao-card">';
    cardHtml += '<div class="opcao-img-wrap">';
    cardHtml += '<img src="' + img + '" alt="">';

    if (isPopular) {
      cardHtml += '<span class="badge-popular">' + t.popular + '</span>';
    }

    cardHtml += '</div>';
    cardHtml += '<div class="opcao-detalhes">';
    cardHtml += '<div class="opcao-texto">';
    cardHtml += '<div class="opcao-nome">' + nomeExibir + '</div>';
    cardHtml += '</div>';
    cardHtml += '<div class="opcao-preco">' + precoStr + '</div>';
    cardHtml += '</div>';
    cardHtml += '</a>';

    return cardHtml;
  }

  async function loadList() {
    // Buscar evento ativo (para sistema de pedidos)
    const { data: evento } = await supabase
      .from("eventos")
      .select("id, nome")
      .eq("ativo", true)
      .limit(1)
      .maybeSingle();

    if (evento) {
      eventoAtivo = evento;
      localStorage.setItem(EVENTO_KEY, evento.id);
    }

    // Buscar categorias
    try {
      const { data: cats, error: errC } = await supabase
        .from("categorias")
        .select("id, nome_pt, nome_ja, emoji, ordem")
        .order("ordem", { ascending: true });

      if (!errC && cats) {
        categorias = cats;
      }
    } catch (e) {
      categorias = [];
    }

    // Buscar items do active_menu + menu_items
    const { data: activeItems, error: errA } = await supabase
      .from("active_menu")
      .select("item_id, preco_atual, menu_items(id, nome, preco_padrao, categoria_id, ordem, popular, foto_url)")
      .eq("ativo", true);

    if (errA || !activeItems || activeItems.length === 0) {
      showError(idioma === "ja" ? "„É°„Éã„É•„Éº„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ" : "Nenhum item no menu ativo.");
      hideLoading();
      return;
    }

    // Map to format expected by renderCategoriasECards
    ultimosItens = activeItems.map(function (a) {
      var mi = a.menu_items;
      return {
        id: mi.id,
        nome: mi.nome,
        preco: a.preco_atual,
        categoria_id: mi.categoria_id,
        ordem: mi.ordem,
        popular: mi.popular,
        foto_url: mi.foto_url
      };
    }).sort(function (a, b) { return (a.ordem || 0) - (b.ordem || 0); });

    renderCategoriasECards(categorias, ultimosItens);

    $main.hidden = false;
    hideLoading();
    updateFloatingCart();
  }

  function escapeHtml(s) {
    const d = document.createElement("div");
    d.textContent = s;
    return d.innerHTML;
  }

  async function init() {
    if (!CONFIG?.supabaseUrl || !CONFIG?.supabaseAnonKey) {
      showError("Configure Supabase em config.js.");
      hideLoading();
      return;
    }
    initSupabase();
    atualizarUI();
    updateFloatingCart();
    await loadList();
  }

  init();
})();
  </script>
</body>
</html>
